package ab.async.tester.controllers

import controllers.BaseControllerSpec
import ab.async.tester.service.organisation.OrganisationService
import ab.async.tester.controllers.auth.{
  AuthorizedAction,
  AuthenticatedAction,
  AuthenticatedRequest
}
import ab.async.tester.domain.organisation.Organisation
import ab.async.tester.domain.common.PaginatedResponse
import ab.async.tester.domain.user.{AuthenticatedUser, UserRole}
import play.api.test.Helpers._
import play.api.test.{FakeRequest, Helpers}
import play.api.libs.json.Json
import play.api.mvc._
import scala.concurrent.{Future, ExecutionContext}
import org.mockito.ArgumentMatchers.any
import io.circe.generic.auto._
import io.circe.syntax._

import utils.StubAuthorizedAction

class OrganisationsControllerSpec extends BaseControllerSpec {

  val mockOrganisationService = mock[OrganisationService]

  val testUser = AuthenticatedUser(
    "user1",
    "user@example.com",
    Some("User"),
    UserRole.User,
    false
  )
  val stubAuthorizedAction = new StubAuthorizedAction(testUser)

  val cc = Helpers.stubControllerComponents()
  val controller = new OrganisationsController(
    cc,
    stubAuthorizedAction,
    mockOrganisationService
  )

  "OrganisationsController" should {
    "getOrganisations should return organisations" in {
      val orgs =
        List(Organisation(Some("1"), "test org", "description", 0L, 0L))
      val response = PaginatedResponse(orgs, 1, 10, 0)

      when(mockOrganisationService.getOrganisations(any, any[Int], any[Int]))
        .thenReturn(Future.successful(response))

      val request = FakeRequest(GET, "/api/v1/organisations")
      val result = controller.getOrganisations(None, None, None).apply(request)

      status(result) mustBe OK
      contentAsJson(result) mustBe Json.parse(response.asJson.noSpaces)
    }

    "getOrganisation should return an organisation" in {
      val org = Organisation(Some("1"), "test org", "description", 0L, 0L)
      when(mockOrganisationService.getOrganisation("1"))
        .thenReturn(Future.successful(Some(org)))

      val request = FakeRequest(GET, "/api/v1/organisations/1")
      val result = controller.getOrganisation("1").apply(request)

      status(result) mustBe OK
      contentAsJson(result) mustBe Json.parse(org.asJson.noSpaces)
    }

    "createOrganisation should create an organisation" in {
      val org = Organisation(Some("1"), "new org", "desc", 0L, 0L)
      when(mockOrganisationService.createOrganisation(any[Organisation]))
        .thenReturn(Future.successful(org))

      val request = FakeRequest(POST, "/api/v1/organisations")
        .withJsonBody(Json.parse(org.asJson.noSpaces))

      val result = controller.createOrganisation().apply(request)

      status(result) mustBe CREATED
    }

    "deleteOrganisation should delete organisation" in {
      when(mockOrganisationService.deleteOrganisation("1"))
        .thenReturn(Future.successful(true))

      val request = FakeRequest(DELETE, "/api/v1/organisations/1")
      val result = controller.deleteOrganisation("1").apply(request)

      status(result) mustBe OK
    }
  }
}
