package ab.async.tester.controllers

import controllers.BaseControllerSpec
import ab.async.tester.service.resource.ResourceService
import ab.async.tester.controllers.auth.{
  AuthorizedAction,
  AuthenticatedAction,
  AuthenticatedRequest
}
import ab.async.tester.domain.resource.ResourceConfig
import ab.async.tester.domain.common.PaginatedResponse
import ab.async.tester.domain.user.{AuthenticatedUser, UserRole}
import play.api.test.Helpers._
import play.api.test.{FakeRequest, Helpers}
import play.api.libs.json.Json
import play.api.mvc._
import scala.concurrent.{Future, ExecutionContext}
import org.mockito.ArgumentMatchers.any
import io.circe.generic.auto._
import io.circe.syntax._

import utils.StubAuthorizedAction

class ResourceControllerSpec extends BaseControllerSpec {

  val mockResourceService = mock[ResourceService]

  val testUser = AuthenticatedUser(
    "user1",
    "user@example.com",
    Some("User"),
    UserRole.User,
    false
  )
  val stubAuthorizedAction = new StubAuthorizedAction(testUser)

  val cc = Helpers.stubControllerComponents()
  val controller =
    new ResourceController(cc, mockResourceService, stubAuthorizedAction)

  "ResourceController" should {
    "getResources should return resources" in {
      val resources = List(
        ResourceConfig(
          Some("1"),
          "test resource",
          "type",
          "group",
          "namespace",
          "payload",
          0L,
          0L
        )
      )
      val response = PaginatedResponse(resources, 1, 10, 0)

      when(mockResourceService.getResources(any, any, any, any[Int], any[Int]))
        .thenReturn(Future.successful(response))

      val request = FakeRequest(GET, "/api/v1/resources")
      val result = controller.getResources().apply(request)

      status(result) mustBe OK
      contentAsJson(result) mustBe Json.parse(response.asJson.noSpaces)
    }

    "getResource should return a resource" in {
      val resource = ResourceConfig(
        Some("1"),
        "test resource",
        "type",
        "group",
        "namespace",
        "payload",
        0L,
        0L
      )
      when(mockResourceService.getResourceById("1"))
        .thenReturn(Future.successful(Some(resource)))

      val request = FakeRequest(GET, "/api/v1/resources/1")
      val result = controller.getResource("1").apply(request)

      status(result) mustBe OK
      contentAsJson(result) mustBe Json.parse(resource.asJson.noSpaces)
    }

    "createResource should create a resource" in {
      val resource = ResourceConfig(
        Some("1"),
        "new resource",
        "type",
        "group",
        "namespace",
        "payload",
        0L,
        0L
      )
      when(mockResourceService.createResource(any[ResourceConfig]))
        .thenReturn(Future.successful(resource))

      val request = FakeRequest(POST, "/api/v1/resources")
        .withJsonBody(Json.parse(resource.asJson.noSpaces))

      val result = controller.createResource().apply(request)

      status(result) mustBe CREATED
    }
  }
}
