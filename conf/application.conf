# This is the main configuration file for the application.
# ~~~~~
play.modules.enabled += "ab.async.tester.modules.DatabaseModule"
play.modules.enabled += "ab.async.tester.AppLifecycleModule"
play.modules.enabled += "ab.async.tester.modules.RedisModule"
play.modules.enabled += "ab.async.tester.modules.FlywayModule"

# Enable GZIP compression
play.filters.enabled += "play.filters.gzip.GzipFilter"
play.filters.disabled += "play.filters.csrf.CSRFFilter"
play.http.filters = "ab.async.tester.filters.Filters"

# Handle OPTIONS requests for CORS
play.filters.cors {
  pathPrefixes = ["/"]
  allowedOrigins = ["*"]
  allowedHttpMethods = ["GET", "POST", "PUT", "DELETE", "OPTIONS"]
  allowedHttpHeaders = ["Accept", "Content-Type", "Origin", "X-Auth-Token", "Authorization"]
  preflightMaxAge = 3 days
  exposedHeaders = ["X-Total-Count"]
}

play.filters {
  hosts {
    allowed = [
      "localhost",
      "127.0.0.1",
      "0.0.0.0",
      "host.docker.internal"
    ]
  }
}

# Secret key
# ~~~~~
# Use a long default for convenience in dev/docker; override in production!
play.http.secret.key = "adkfjalskdghalskdjghalskdjghalskdjghalskdjghalskdjgh"
play.http.secret.key = ${?PLAY_SECRET}

# The application languages
# ~~~~~
play.i18n.langs = ["en"]

# Router
# ~~~~~
play.http.router = "router.Routes"

# Database configuration
# ~~~~~
# PostgreSQL configuration for Slick
slick.dbs.default {
  profile = "ab.async.tester.library.driver.MyPostgresProfile$"
  db {
    driver = "org.postgresql.Driver"
    url = "jdbc:postgresql://localhost:6432/asynctester"
    url = ${?POSTGRES_URL}
    user = "asynctester"
    user = ${?POSTGRES_USER}
    password = "asynctester"
    password = ${?POSTGRES_PASSWORD}
    connectionPool = "HikariCP"
    maximumPoolSize = 10
    minimumIdle = 5
  }
}

# Flyway configuration for database migrations
play.evolutions.enabled = false
play.evolutions.autoApply = false

# Enable Flyway for database migrations
flyway {
  url = "jdbc:postgresql://localhost:6432/asynctester"
  url = ${?POSTGRES_URL}
  user = "asynctester"
  user = ${?POSTGRES_USER}
  password = "asynctester"
  password = ${?POSTGRES_PASSWORD}
  locations = ["classpath:db/migration"]
  baselineOnMigrate = true
  validateOnMigrate = true
}

kafka {
  bootstrapServers = "localhost:9092"
  bootstrapServers = ${?KAFKA_BOOTSTRAP_SERVERS}
  brokers = "localhost:9092"
  brokers = ${?KAFKA_BOOTSTRAP_SERVERS}
  groupId = "async-tester"
  groupId = ${?KAFKA_GROUP_ID}
  topic = "flow-executions"
  pullTimeoutMs = 5000
}

events = {
  workerQueueTopic = "flow-executions"
  testSuiteExecutionTopic = "test-suite-executions"
}

# Redis configuration
# ~~~~~
redis {
  host = "localhost"
  host = ${?REDIS_HOST}
  port = 6379
  port = ${?REDIS_PORT}
  password = ""
  password = ${?REDIS_PASSWORD}
}

# Server configuration
# ~~~~~
play.server {
  http.port = 9000
}

# Akka configuration
# ~~~~~
akka {
  log-dead-letters = 10
  log-dead-letters-during-shutdown = on
  loglevel = "INFO"

  # Disable Jackson serialization if not needed
  actor {
    serializers {
      java = "akka.serialization.JavaSerializer"
    }
    serialization-bindings {
      "java.io.Serializable" = java
    }
  }
}

# Metrics configuration
# ~~~~~
metrics {
  enabled = true
  port = 8080
}

google.clientId = "dummy-client-id"
google.clientId = ${?GOOGLE_CLIENT_ID}
jwt.secret = "dummy-secret"
jwt.secret = ${?JWT_SECRET}

# Request body parser configuration
# ~~~~~
play.http.parser.maxMemoryBuffer = 10M

# SQL Query Security Configuration
# ~~~~~
sql.security {
  # Maximum number of rows allowed in SELECT queries
  maxRows = 100

  # Allowed tables for SELECT queries
  allowedTables = [
    "flows"
  ]

  # Whether to enforce table restrictions (set to false to allow all tables)
  enforceTableRestrictions = true
}

services = {
    email = {
        email = "not-set"
        email = ${?EMAIL_PASSWORD_USERNAME}
        password = "not-set"
        password = ${?EMAIL_PASSWORD}
    }
}

auth {
    jwt = {
        secret = "default-jwt-secret"
        secret = ${?JWT_SECRET}
        expiryHours = 2
        refreshTokenExpiryDays = 1
    }
}